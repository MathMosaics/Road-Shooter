<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Road: Ultimate Squad</title>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-pink: #ff0077;
            --neon-purple: #bc13fe;
            --neon-red: #ff3131;
            --neon-yellow: #ffcc00;
            --neon-green: #39ff14;
        }
        body { 
            margin: 0; background: #050508; color: #fff; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            overflow: hidden; touch-action: none;
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }
        #game-container {
            position: relative; background: #000; width: 100%; height: 100%; max-width: 500px;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        #ui-layer {
            position: absolute; top: 10px; left: 0; width: 100%; padding: 15px;
            box-sizing: border-box; pointer-events: none; display: flex;
            justify-content: space-between; z-index: 5;
        }
        .stat-box { background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.1); }
        .stat-label { font-size: 9px; color: var(--neon-blue); display: block; text-transform: uppercase; letter-spacing: 1.5px; }
        .stat-value { font-size: 18px; font-weight: 900; }

        #xp-container { position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: rgba(255,255,255,0.05); z-index: 10; }
        #xp-bar { height: 100%; width: 0%; background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); transition: width 0.3s; }

        #boss-ui {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            width: 80%; display: none; text-align: center; z-index: 10;
        }
        #boss-hp-bg { width: 100%; height: 12px; background: #222; border: 2px solid var(--neon-red); border-radius: 6px; overflow: hidden; }
        #boss-hp-fill { height: 100%; width: 100%; background: var(--neon-red); }
        #boss-name { font-size: 12px; color: var(--neon-red); text-transform: uppercase; font-weight: bold; margin-bottom: 4px; display: block; }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 10, 0.95); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 20; padding: 20px;
            box-sizing: border-box; backdrop-filter: blur(15px);
        }
        h2 { color: var(--neon-pink); font-size: 32px; margin: 0; text-shadow: 0 0 20px var(--neon-pink); }
        .btn {
            padding: 16px; font-size: 14px; font-weight: bold; cursor: pointer;
            border: 2px solid var(--neon-blue); background: rgba(0, 242, 255, 0.1);
            color: var(--neon-blue); margin: 8px; border-radius: 12px;
            text-transform: uppercase; width: 100%; max-width: 280px; pointer-events: auto;
        }
        .shop-grid { width: 100%; display: flex; flex-direction: column; gap: 8px; margin: 15px 0; max-height: 50vh; overflow-y: auto; pointer-events: auto; }
        .shop-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1); text-align: left;
        }
        .shop-item.active { border-color: var(--neon-green); background: rgba(57, 255, 20, 0.1); }
        #phase-msg { position: absolute; bottom: 30%; left: 50%; transform: translateX(-50%); color: var(--neon-pink); font-weight: 900; opacity: 0; pointer-events: none; font-size: 24px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="xp-container"><div id="xp-bar"></div></div>
    <div id="phase-msg">PHASE SHIFT</div>
    
    <div id="boss-ui">
        <span id="boss-name">GOLIATH UNIT</span>
        <div id="boss-hp-bg"><div id="boss-hp-fill"></div></div>
    </div>

    <div id="ui-layer">
        <div class="stat-box">
            <span class="stat-label">Stash</span>
            <span id="coin-display" class="stat-value">0</span>
        </div>
        <div class="stat-box" style="text-align: right;">
            <span class="stat-label">Mission Rank</span>
            <span id="rank-display" class="stat-value">1</span>
        </div>
    </div>

    <div id="menu-overlay" class="overlay" style="display: flex;">
        <h2>NEON ROAD</h2>
        <p style="color: #888; margin: 10px 0; font-size: 13px;">Squad Formation: CLUSTER V1</p>
        <button class="btn" onclick="game.start()">Deploy Squad</button>
        <button class="btn" style="border-color: var(--neon-purple); color: var(--neon-purple);" onclick="game.openShop()">Armory & Tech</button>
    </div>

    <div id="shop-overlay" class="overlay">
        <h2 style="color: var(--neon-purple)">THE ARMORY</h2>
        <div id="shop-items" class="shop-grid"></div>
        <button class="btn" onclick="game.toggleOverlay('shop-overlay', false)">Back to HQ</button>
    </div>

    <div id="death-overlay" class="overlay">
        <h2 style="color: var(--neon-red)">SQUAD WIPED</h2>
        <p id="death-msg" style="color:#aaa; font-size: 14px; margin: 15px 0;">Hostile strength exceeded squad capacity.</p>
        <button class="btn" onclick="game.start()">Redeploy</button>
        <button class="btn" style="border-color: #555; color: #555;" onclick="game.toggleOverlay('death-overlay', false); game.toggleOverlay('menu-overlay', true);">Exit to Menu</button>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });

let width, height, laneWidth;

const WEAPON_TYPES = {
    plasma: { name: 'PLASMA', color: '#00f2ff', type: 'standard', cost: 0, desc: 'Tight spread. Reliable.' },
    pulse: { name: 'PULSE', color: '#bc13fe', type: 'pierce', cost: 5000, desc: 'Piercing bolts. Slower.' },
    nova: { name: 'NOVA', color: '#ffcc00', type: 'explosive', cost: 8000, desc: 'Heavy impact. Splash dmg.' }
};

function resize() {
    const container = document.getElementById('game-container');
    width = container.clientWidth;
    height = container.clientHeight;
    canvas.width = width;
    canvas.height = height;
    laneWidth = width / 2;
}
window.addEventListener('resize', resize);
resize();

class Game {
    constructor() {
        this.loadData();
        this.reset();
        this.setupInput();
        this.loop();
    }

    loadData() {
        const saved = localStorage.getItem('neon_road_v9');
        this.upgrades = saved ? JSON.parse(saved) : {
            multiShot: 0, damage: 0, coinGain: 0, fireRate: 0,
            weaponType: 'plasma', ownedWeapons: ['plasma']
        };
        this.totalCoins = parseInt(localStorage.getItem('neon_road_coins')) || 0;
    }

    saveData() {
        localStorage.setItem('neon_road_v9', JSON.stringify(this.upgrades));
        localStorage.setItem('neon_road_coins', Math.floor(this.totalCoins));
    }

    reset() {
        this.isActive = false;
        this.frame = 0;
        this.entities = [];
        this.bullets = [];
        this.enemyBullets = [];
        this.particles = [];
        this.playerLane = 0;
        this.currentX = laneWidth / 2;
        this.isFiring = false;
        this.rank = 1;
        this.xp = 0;
        this.xpToNext = 120;
        this.isPhasing = false;
        this.phaseTimer = 0;
        this.shake = 0;
        this.bossActive = false;
        
        this.squadSize = 1 + this.upgrades.multiShot;
        this.fireRate = 18 - (this.upgrades.fireRate * 1.5);
        this.damage = 1 + (this.upgrades.damage * 0.5);
        this.currentWeapon = WEAPON_TYPES[this.upgrades.weaponType || 'plasma'];
        
        document.getElementById('boss-ui').style.display = 'none';
        this.updateUI();
    }

    setupInput() {
        const handleInteraction = (clientX) => {
            if (!this.isActive) return;
            const rect = canvas.getBoundingClientRect();
            const x = clientX - rect.left;
            const newLane = x < laneWidth ? 0 : 1;
            
            if (newLane !== this.playerLane) {
                this.isPhasing = true;
                this.phaseTimer = 20;
            }
            this.playerLane = newLane;
            this.isFiring = true;
        };

        canvas.addEventListener('touchstart', (e) => { handleInteraction(e.touches[0].clientX); e.preventDefault(); }, { passive: false });
        canvas.addEventListener('touchmove', (e) => { handleInteraction(e.touches[0].clientX); e.preventDefault(); }, { passive: false });
        canvas.addEventListener('touchend', () => this.isFiring = false);
        canvas.addEventListener('mousedown', (e) => handleInteraction(e.clientX));
        window.addEventListener('mouseup', () => this.isFiring = false);
    }

    start() {
        this.reset();
        this.isActive = true;
        this.toggleOverlay('menu-overlay', false);
        this.toggleOverlay('death-overlay', false);
    }

    toggleOverlay(id, show) {
        document.getElementById(id).style.display = show ? 'flex' : 'none';
    }

    updateUI() {
        document.getElementById('coin-display').innerText = Math.floor(this.totalCoins);
        document.getElementById('rank-display').innerText = this.rank;
        document.getElementById('xp-bar').style.width = `${(this.xp / this.xpToNext) * 100}%`;
        document.getElementById('phase-msg').style.opacity = this.isPhasing ? 1 : 0;
    }

    spawn() {
        if (this.bossActive) return;

        // Boss Check
        if (this.rank > 0 && this.rank % 5 === 0 && !this.entities.some(e => e.type === 'boss')) {
            this.spawnBoss();
            return;
        }

        const lane = Math.random() > 0.5 ? 1 : 0;
        const x = (lane * laneWidth) + (laneWidth / 2);
        const rankScaling = 1 + (this.rank * 0.25);
        
        if (Math.random() > 0.8) {
            // Barrier
            const isHardGate = Math.random() > 0.8;
            const value = isHardGate ? -(Math.floor(Math.random()*5 + 3)) : Math.floor(Math.random()*4 + 1);
            this.entities.push({
                type: 'barrier', x, y: -80, lane, value, hp: 0, 
                maxHp: (isHardGate ? 25 : 12) * rankScaling * this.damage,
                speed: 3.5 + (this.rank * 0.1)
            });
        } else {
            // Monster
            const hp = 5 * rankScaling;
            this.entities.push({
                type: 'monster', x, y: -50, lane, hp, maxHp: hp, scale: 1.2, color: '#bc13fe',
                speed: 4 + Math.random() * 2,
                xp: 15,
                fireCooldown: 60 + Math.random() * 100
            });
        }
    }

    spawnBoss() {
        this.bossActive = true;
        const hp = 500 * (1 + (this.rank * 0.4));
        this.entities.push({
            type: 'boss', x: width / 2, y: -150, hp, maxHp: hp, scale: 4.5, color: '#ff3131',
            speed: 1, xp: 500, fireCooldown: 60
        });
        document.getElementById('boss-ui').style.display = 'block';
        document.getElementById('boss-hp-fill').style.width = '100%';
    }

    update() {
        if (!this.isActive) return;
        this.frame++;

        if (this.shake > 0) this.shake *= 0.9;
        if (this.isPhasing) {
            this.phaseTimer--;
            if (this.phaseTimer <= 0) this.isPhasing = false;
        }

        const targetX = (this.playerLane * laneWidth) + (laneWidth / 2);
        this.currentX += (targetX - this.currentX) * 0.2;

        if (this.frame % 45 === 0) this.spawn();

        if (this.isFiring && this.frame % Math.floor(this.fireRate) === 0) {
            this.fire();
        }

        // Entity Logic
        for (let i = this.entities.length - 1; i >= 0; i--) {
            const e = this.entities[i];
            
            if (e.type === 'boss') {
                e.y = Math.min(180, e.y + e.speed);
                e.x += Math.sin(this.frame * 0.02) * 2;
                e.fireCooldown--;
                if (e.fireCooldown <= 0) {
                    this.enemyBullets.push({ x: e.x, y: e.y + 20, vy: 7 });
                    this.enemyBullets.push({ x: e.x - 40, y: e.y + 10, vy: 7 });
                    this.enemyBullets.push({ x: e.x + 40, y: e.y + 10, vy: 7 });
                    e.fireCooldown = 40;
                }
            } else {
                e.y += e.speed;
                if (e.type === 'monster') {
                    e.fireCooldown--;
                    if (e.fireCooldown <= 0) {
                        this.enemyBullets.push({ x: e.x, y: e.y, vy: 5 + (this.rank * 0.2) });
                        e.fireCooldown = 120;
                    }
                }
            }

            // Bullet Collision
            for (let j = this.bullets.length - 1; j >= 0; j--) {
                const b = this.bullets[j];
                const dx = b.x - e.x;
                const dy = b.y - e.y;
                const radius = e.type === 'barrier' ? 60 : 40 * e.scale;

                if (Math.sqrt(dx*dx + dy*dy) < radius) {
                    const dmg = this.damage * (b.dmgMult || 1);
                    if (e.type === 'barrier') {
                        e.hp += dmg;
                        if (e.hp >= e.maxHp) {
                            if (e.value > 0) this.squadSize += e.value;
                            this.createExplosion(e.x, e.y, e.value > 0 ? '#00f2ff' : '#ff3131', 8);
                            this.entities.splice(i, 1);
                        }
                    } else {
                        e.hp -= dmg;
                        if (e.type === 'boss') {
                            document.getElementById('boss-hp-fill').style.width = `${(e.hp/e.maxHp)*100}%`;
                        }
                        if (e.hp <= 0) {
                            this.totalCoins += 20 * e.scale * (1 + (this.upgrades.coinGain * 0.2));
                            this.xp += e.xp;
                            this.createExplosion(e.x, e.y, e.color, 15);
                            if (e.type === 'boss') {
                                this.bossActive = false;
                                document.getElementById('boss-ui').style.display = 'none';
                            }
                            this.entities.splice(i, 1);
                            if (this.xp >= this.xpToNext) this.rankUp();
                        }
                    }
                    if (this.currentWeapon.type !== 'pierce') this.bullets.splice(j, 1);
                    break;
                }
            }

            // Player Collision (Death)
            if (this.entities[i] && Math.abs(e.y - (height - 130)) < 40) {
                if (Math.abs(e.x - this.currentX) < 50) {
                    if (e.type === 'barrier') {
                        this.squadSize += e.value;
                        this.entities.splice(i, 1);
                        if (this.squadSize < 1) this.die();
                    } else if (!this.isPhasing) {
                        this.die();
                    }
                }
            }
            if (e && e.y > height + 200) this.entities.splice(i, 1);
        }

        // Projectile cleanup
        this.bullets.forEach((b, k) => {
            b.y -= 14; 
            if (b.y < -50) this.bullets.splice(k, 1);
        });

        for (let i = this.enemyBullets.length - 1; i >= 0; i--) {
            const eb = this.enemyBullets[i];
            eb.y += eb.vy;
            if (Math.abs(eb.y - (height - 130)) < 25 && Math.abs(eb.x - this.currentX) < 40 && !this.isPhasing) {
                this.die();
            }
            if (eb.y > height + 50) this.enemyBullets.splice(i, 1);
        }

        this.particles.forEach((p, k) => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.04;
            if (p.life <= 0) this.particles.splice(k, 1);
        });
    }

    rankUp() {
        this.rank++;
        this.xp = 0;
        this.xpToNext = Math.floor(this.xpToNext * 1.4);
        this.damage += 0.3;
        this.createExplosion(width / 2, height / 2, '#39ff14', 30);
    }

    fire() {
        const count = Math.min(25, Math.floor(this.squadSize));
        const angleStep = 0.04;
        const baseAngle = -Math.PI / 2;

        for (let i = 0; i < count; i++) {
            // CLUSTER V-SHAPE: Position squad in a tighter group
            const row = Math.floor(i / 5);
            const col = i % 5;
            const sx = this.currentX + (col - 2) * 15;
            const sy = (height - 130) + row * 18;

            // Aiming logic: converge slightly
            const angle = baseAngle + (col - 2) * angleStep;
            const vx = Math.cos(angle) * 2;
            
            this.bullets.push({ 
                x: sx, y: sy, 
                vx: vx, 
                dmgMult: this.currentWeapon.type === 'explosive' ? 2.5 : 1 
            });
        }
    }

    createExplosion(x, y, color, count) {
        for (let i = 0; i < count; i++) {
            this.particles.push({
                x, y, color,
                vx: (Math.random() - 0.5) * 12,
                vy: (Math.random() - 0.5) * 12,
                life: 1.0
            });
        }
    }

    die() {
        this.isActive = false;
        this.toggleOverlay('death-overlay', true);
        this.saveData();
    }

    openShop() {
        const container = document.getElementById('shop-items');
        container.innerHTML = '';
        
        // Weapon Section
        const weaponHeader = document.createElement('div');
        weaponHeader.style = 'color: #555; font-size: 10px; text-transform: uppercase; margin: 10px 0;';
        weaponHeader.innerText = 'Arsenal Selection';
        container.appendChild(weaponHeader);

        Object.keys(WEAPON_TYPES).forEach(key => {
            const w = WEAPON_TYPES[key];
            const owned = this.upgrades.ownedWeapons.includes(key);
            const active = this.upgrades.weaponType === key;
            const div = document.createElement('div');
            div.className = `shop-item ${active ? 'active' : ''}`;
            div.onclick = () => {
                if (owned) { this.upgrades.weaponType = key; } 
                else if (this.totalCoins >= w.cost) {
                    this.totalCoins -= w.cost; this.upgrades.ownedWeapons.push(key); this.upgrades.weaponType = key;
                }
                this.saveData(); this.openShop(); this.updateUI();
            };
            div.innerHTML = `<div><span style="color:${w.color}; font-weight:bold">${w.name}</span><br><small style="color:#777">${w.desc}</small></div>
                             <div style="color:var(--neon-yellow)">${owned ? (active ? 'EQUIPPED' : 'OWNED') : w.cost}</div>`;
            container.appendChild(div);
        });

        // Upgrade Section
        const upgradeHeader = weaponHeader.cloneNode(true);
        upgradeHeader.innerText = 'Squad Reinforcements';
        container.appendChild(upgradeHeader);

        const catalog = [
            { id: 'multiShot', name: 'Start Squad +1', cost: 1200 },
            { id: 'fireRate', name: 'Cycle Speed', cost: 1000 },
            { id: 'damage', name: 'Power Cells', cost: 900 }
        ];

        catalog.forEach(item => {
            const level = this.upgrades[item.id] || 0;
            const cost = Math.floor(item.cost * Math.pow(1.6, level));
            const div = document.createElement('div');
            div.className = 'shop-item';
            div.onclick = () => {
                if (this.totalCoins >= cost) {
                    this.totalCoins -= cost; this.upgrades[item.id]++;
                    this.saveData(); this.openShop(); this.updateUI();
                }
            };
            div.innerHTML = `<div><span style="font-weight:bold">${item.name}</span><br><small style="color:#777">Lvl ${level}</small></div>
                             <div style="color:var(--neon-yellow)">${cost}</div>`;
            container.appendChild(div);
        });
        
        this.toggleOverlay('shop-overlay', true);
    }

    draw() {
        ctx.fillStyle = '#050508';
        ctx.fillRect(0, 0, width, height);

        // Grid Lines
        ctx.strokeStyle = 'rgba(0, 242, 255, 0.05)';
        ctx.lineWidth = 1;
        for(let i=0; i<width; i+=laneWidth) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,height); ctx.stroke(); }

        // Particles
        this.particles.forEach(p => {
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 3, 3);
        });
        ctx.globalAlpha = 1;

        // Player Bullets
        ctx.fillStyle = this.currentWeapon.color;
        this.bullets.forEach(b => {
            if (this.currentWeapon.type === 'pierce') ctx.fillRect(b.x-4, b.y, 8, 25);
            else ctx.fillRect(b.x-2, b.y, 4, 18);
        });

        // Enemy Bullets
        ctx.fillStyle = '#ff3131';
        this.enemyBullets.forEach(eb => {
            ctx.beginPath(); ctx.arc(eb.x, eb.y, 5, 0, Math.PI*2); ctx.fill();
        });

        // Entities
        this.entities.forEach(e => {
            if (e.type === 'barrier') {
                const color = e.value > 0 ? '#00f2ff' : '#ff3131';
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.strokeRect(e.x - 60, e.y - 25, 120, 50);
                ctx.fillStyle = 'rgba(0,0,0,0.8)';
                ctx.fillRect(e.x - 60, e.y - 25, 120, 50);
                ctx.fillStyle = color;
                ctx.font = 'bold 20px monospace';
                ctx.textAlign = 'center';
                ctx.fillText((e.value > 0 ? '+' : '') + e.value, e.x, e.y + 7);
            } else {
                this.drawEnemy(ctx, e.x, e.y, e.scale, e.color);
            }
        });

        // Player Squad (V-Shape)
        const sCount = Math.floor(this.squadSize);
        ctx.fillStyle = this.isPhasing ? 'rgba(0, 242, 255, 0.3)' : '#00f2ff';
        for (let i = 0; i < sCount; i++) {
            const row = Math.floor(i / 5);
            const col = i % 5;
            const x = this.currentX + (col - 2) * 15;
            const y = (height - 130) + row * 18;
            ctx.beginPath(); ctx.arc(x, y, 7, 0, Math.PI * 2); ctx.fill();
            if(!this.isPhasing) { ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.stroke(); }
        }
    }

    drawEnemy(ctx, x, y, scale, color) {
        ctx.save();
        ctx.translate(x, y);
        ctx.scale(scale, scale);
        ctx.fillStyle = color;
        ctx.fillRect(-10, -5, 20, 10);
        ctx.fillRect(-6, -8, 2, 3);
        ctx.fillRect(4, -8, 2, 3);
        ctx.fillStyle = '#000';
        ctx.fillRect(-5, -2, 3, 3);
        ctx.fillRect(2, -2, 3, 3);
        ctx.restore();
    }

    loop() {
        this.update();
        this.draw();
        requestAnimationFrame(() => this.loop());
    }
}

const game = new Game();
</script>
</body>
</html>
